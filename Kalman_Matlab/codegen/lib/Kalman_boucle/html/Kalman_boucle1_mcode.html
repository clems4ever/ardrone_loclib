<pre class="code">
<span class="srcline"><span class="lineno"><a href="1,1" id="srcline1"> 1</a></span><span class="line"><span class="keyword">function</span> [ <span class="var type0" id="S2T0U3">Xk</span>,<span class="var type0" id="S3T0U4">Pk</span>,<span class="var type0" id="S4T0U5">Prediction</span> ] = <span class="message error" id="M1F1C">Kalman_boucle</span>( <span class="var type0" id="S5T0U8">R</span>, <span class="var type0" id="S6T0U9">Xprec</span>, <span class="var type0" id="S7T0U10">Pprec</span>, <span class="var type0" id="S8T0U11">Zprec</span> )</span></span>
<span class="srcline"><span class="lineno"><a href="1,2" id="srcline2"> 2</a></span><span class="line"><span class="comment">%KALMAN_boucle Summary of this function goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,3" id="srcline3"> 3</a></span><span class="line"><span class="comment">%   Detailed explanation goes here</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,4" id="srcline4"> 4</a></span><span class="line"><span class="comment">% Boucle de filtre de Kalman</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,5" id="srcline5"> 5</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,6" id="srcline6"> 6</a></span><span class="line"><span class="comment">%Initialisations</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,7" id="srcline7"> 7</a></span><span class="line">    <span class="comment">%Temps d'échantillonnage</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,8" id="srcline8"> 8</a></span><span class="line">    <span class="var type0" id="S9T0U14">Te</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,9" id="srcline9"> 9</a></span><span class="line">    <span class="comment">%Process noise</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,10" id="srcline10">10</a></span><span class="line">    <span class="var type0" id="S10T0U18">incertitude_modele</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,11" id="srcline11">11</a></span><span class="line">    <span class="var type0" id="S11T0U22">Q</span> = <span class="var type0" id="S10T0U24">incertitude_modele</span> * eye(4);</span></span>
<span class="srcline"><span class="lineno"><a href="1,12" id="srcline12">12</a></span><span class="line">    <span class="var type0" id="S13T0U30">M</span> = 1;</span></span>
<span class="srcline"><span class="lineno"><a href="1,13" id="srcline13">13</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,14" id="srcline14">14</a></span><span class="line">    <span class="var type0" id="S2T0U34">Xk</span>=zeros(4,1);  <span class="comment">%6 si on prend en compte l'accélération</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,15" id="srcline15">15</a></span><span class="line">    <span class="var type0" id="S4T0U41">Prediction</span>=zeros(4,1);  <span class="comment">%6 si on prend en compte l'accélération</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,16" id="srcline16">16</a></span><span class="line">    <span class="var type0" id="S3T0U48">Pk</span>=eye(4);     <span class="comment">%6 si on prend en compte l'accélération</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,17" id="srcline17">17</a></span><span class="line">    <span class="var type0" id="S15T0U54">Zk</span>=zeros(8,1); <span class="comment">%10 si on prend en compte l'accélération</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,18" id="srcline18">18</a></span><span class="line">    <span class="var type0" id="S16T0U61">In</span>=zeros(8,1); <span class="comment">%10</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,19" id="srcline19">19</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,20" id="srcline20">20</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,21" id="srcline21">21</a></span><span class="line">    <span class="comment">% Matrice d'état</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,22" id="srcline22">22</a></span><span class="line">    <span class="var type0" id="S17T0U68">A</span> = [1  0  <span class="var type0" id="S9T0U73">Te</span>   0;      <span class="comment">%position, vitesse sur X</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,23" id="srcline23">23</a></span><span class="line">         0  1   0   <span class="var type0" id="S9T0U79">Te</span>;     <span class="comment">%position, vitesse sur X </span></span></span>
<span class="srcline"><span class="lineno"><a href="1,24" id="srcline24">24</a></span><span class="line">         0  0   1   0;      <span class="comment">%vitesse sur X</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,25" id="srcline25">25</a></span><span class="line">         0  0   0   1];     <span class="comment">%vitesse sur Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,26" id="srcline26">26</a></span><span class="line"></span></span>
<span class="srcline"><span class="lineno"><a href="1,27" id="srcline27">27</a></span><span class="line">    <span class="comment">% Matrice des mesures</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,28" id="srcline28">28</a></span><span class="line">    <span class="var type0" id="S18T0U92">C</span>=[ 1 0 0 0      <span class="comment">%position X     GPS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,29" id="srcline29">29</a></span><span class="line">        0 1 0 0      <span class="comment">%position Y     GPS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,30" id="srcline30">30</a></span><span class="line">        1 0 0 0      <span class="comment">%position X     ODOM</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,31" id="srcline31">31</a></span><span class="line">        0 1 0 0      <span class="comment">%position Y     ODOM</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,32" id="srcline32">32</a></span><span class="line">        1 0 0 0      <span class="comment">%position X     TAG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,33" id="srcline33">33</a></span><span class="line">        0 1 0 0      <span class="comment">%position Y     TAG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,34" id="srcline34">34</a></span><span class="line">        0 0 1 0      <span class="comment">%vitesse X      VIMU</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,35" id="srcline35">35</a></span><span class="line">        0 0 0 1];    <span class="comment">%vitesse Y      VIMU</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,36" id="srcline36">36</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,37" id="srcline37">37</a></span><span class="line">    <span class="comment">%Maj de C en fonction de la présence où non des mesures /!\</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,38" id="srcline38">38</a></span><span class="line">     <span class="comment">%GPS</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,39" id="srcline39">39</a></span><span class="line">     <span class="keyword">if</span> ( <span class="var type0" id="S8T0U140">Zprec</span>(1) == 2000000 || <span class="var type0" id="S8T0U145">Zprec</span>(2) == 2000000 )</span></span>
<span class="srcline"><span class="lineno"><a href="1,40" id="srcline40">40</a></span><span class="line">        <span class="var type0" id="S18T0U151">C</span>(1,:) = [0 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,41" id="srcline41">41</a></span><span class="line">        <span class="var type0" id="S18T0U163">C</span>(2,:) = [0 0 0 0];     </span></span>
<span class="srcline"><span class="lineno"><a href="1,42" id="srcline42">42</a></span><span class="line">     <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,43" id="srcline43">43</a></span><span class="line">         <span class="var type0" id="S18T0U176">C</span>(1,:) = [1 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,44" id="srcline44">44</a></span><span class="line">         <span class="var type0" id="S18T0U188">C</span>(2,:) = [0 1 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,45" id="srcline45">45</a></span><span class="line">     <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,46" id="srcline46">46</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,47" id="srcline47">47</a></span><span class="line">     <span class="comment">%ODOM</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,48" id="srcline48">48</a></span><span class="line">     <span class="keyword">if</span> ( <span class="var type0" id="S8T0U203">Zprec</span>(3) == 2000000 || <span class="var type0" id="S8T0U208">Zprec</span>(4) == 2000000 )</span></span>
<span class="srcline"><span class="lineno"><a href="1,49" id="srcline49">49</a></span><span class="line">        <span class="var type0" id="S18T0U214">C</span>(3,:) = [0 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,50" id="srcline50">50</a></span><span class="line">        <span class="var type0" id="S18T0U226">C</span>(4,:) = [0 0 0 0];     </span></span>
<span class="srcline"><span class="lineno"><a href="1,51" id="srcline51">51</a></span><span class="line">     <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,52" id="srcline52">52</a></span><span class="line">         <span class="var type0" id="S18T0U239">C</span>(3,:) = [1 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,53" id="srcline53">53</a></span><span class="line">         <span class="var type0" id="S18T0U251">C</span>(4,:) = [0 1 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,54" id="srcline54">54</a></span><span class="line">     <span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,55" id="srcline55">55</a></span><span class="line">     </span></span>
<span class="srcline"><span class="lineno"><a href="1,56" id="srcline56">56</a></span><span class="line">     <span class="comment">%TAG</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,57" id="srcline57">57</a></span><span class="line">     <span class="keyword">if</span> ( <span class="var type0" id="S8T0U266">Zprec</span>(5) == 2000000 || <span class="var type0" id="S8T0U271">Zprec</span>(6) == 2000000 )</span></span>
<span class="srcline"><span class="lineno"><a href="1,58" id="srcline58">58</a></span><span class="line">        <span class="var type0" id="S18T0U277">C</span>(5,:) = [0 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,59" id="srcline59">59</a></span><span class="line">        <span class="var type0" id="S18T0U289">C</span>(6,:) = [0 0 0 0];      </span></span>
<span class="srcline"><span class="lineno"><a href="1,60" id="srcline60">60</a></span><span class="line">     <span class="keyword">else</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,61" id="srcline61">61</a></span><span class="line">         <span class="var type0" id="S18T0U302">C</span>(5,:) = [1 0 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,62" id="srcline62">62</a></span><span class="line">         <span class="var type0" id="S18T0U314">C</span>(6,:) = [0 1 0 0];</span></span>
<span class="srcline"><span class="lineno"><a href="1,63" id="srcline63">63</a></span><span class="line">     <span class="keyword">end</span>   </span></span>
<span class="srcline"><span class="lineno"><a href="1,64" id="srcline64">64</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,65" id="srcline65">65</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,66" id="srcline66">66</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,67" id="srcline67">67</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,68" id="srcline68">68</a></span><span class="line">    <span class="comment">%Prediction</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,69" id="srcline69">69</a></span><span class="line">    <span class="var type0" id="S2T0U325">Xk</span>=<span class="var type0" id="S17T0U327">A</span>*<span class="var type0" id="S6T0U328">Xprec</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,70" id="srcline70">70</a></span><span class="line">    <span class="var type0" id="S3T0U331">Pk</span>=<span class="var type0" id="S17T0U334">A</span>*<span class="var type0" id="S7T0U335">Pprec</span>+(<span class="var type0" id="S13T0U339">M</span>*<span class="var type0" id="S11T0U340">Q</span>*<span class="var type0" id="S13T0U342">M</span>');</span></span>
<span class="srcline"><span class="lineno"><a href="1,71" id="srcline71">71</a></span><span class="line">        </span></span>
<span class="srcline"><span class="lineno"><a href="1,72" id="srcline72">72</a></span><span class="line">    <span class="comment">%Innovation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,73" id="srcline73">73</a></span><span class="line">    <span class="var type0" id="S16T0U345">In</span>=<span class="var type0" id="S8T0U347">Zprec</span>-(<span class="var type0" id="S18T0U350">C</span>*<span class="var type0" id="S2T0U351">Xk</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,74" id="srcline74">74</a></span><span class="line">    <span class="var type0" id="S19T0U354">Kk</span>=<span class="var type0" id="S3T0U357">Pk</span>*<span class="var type0" id="S18T0U359">C</span>'*inv((<span class="var type0" id="S18T0U366">C</span>*<span class="var type0" id="S3T0U367">Pk</span>*<span class="var type0" id="S18T0U369">C</span>')+<span class="var type0" id="S5T0U370">R</span>);</span></span>
<span class="srcline"><span class="lineno"><a href="1,75" id="srcline75">75</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,76" id="srcline76">76</a></span><span class="line">    <span class="comment">%Mise a jour</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,77" id="srcline77">77</a></span><span class="line">    <span class="var type0" id="S2T0U373">Xk</span>=<span class="var type0" id="S2T0U375">Xk</span>+<span class="var type0" id="S19T0U377">Kk</span>*<span class="var type0" id="S16T0U378">In</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,78" id="srcline78">78</a></span><span class="line">    <span class="var type0" id="S3T0U381">Pk</span>=(eye(4)-<span class="var type0" id="S19T0U389">Kk</span>*<span class="var type0" id="S18T0U390">C</span>)*<span class="var type0" id="S3T0U391">Pk</span>;</span></span>
<span class="srcline"><span class="lineno"><a href="1,79" id="srcline79">79</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,80" id="srcline80">80</a></span><span class="line">    <span class="comment">%Incrementation</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,81" id="srcline81">81</a></span><span class="line">    <span class="var type0" id="S4T0U395">Prediction</span>(1)=<span class="var type0" id="S2T0U398">Xk</span>(1); <span class="comment">%X</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,82" id="srcline82">82</a></span><span class="line">    <span class="var type0" id="S4T0U403">Prediction</span>(2)=<span class="var type0" id="S2T0U406">Xk</span>(2); <span class="comment">%Y</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,83" id="srcline83">83</a></span><span class="line">    <span class="var type0" id="S4T0U411">Prediction</span>(3)=<span class="var type0" id="S2T0U414">Xk</span>(3); <span class="comment">%VX</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,84" id="srcline84">84</a></span><span class="line">    <span class="var type0" id="S4T0U419">Prediction</span>(4)=<span class="var type0" id="S2T0U422">Xk</span>(4); <span class="comment">%VY</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,85" id="srcline85">85</a></span><span class="line">    </span></span>
<span class="srcline"><span class="lineno"><a href="1,86" id="srcline86">86</a></span><span class="line"><span class="keyword">end</span></span></span>
<span class="srcline"><span class="lineno"><a href="1,87" id="srcline87">87</a></span><span class="line"></span></span>
</pre>
